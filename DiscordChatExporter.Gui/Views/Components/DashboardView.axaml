<UserControl
    Loaded="UserControl_OnLoaded"
    x:Class="DiscordChatExporter.Gui.Views.Components.DashboardView"
    x:DataType="components:DashboardViewModel"
    x:Name="UserControl"
    xmlns="https://github.com/avaloniaui"
    xmlns:asyncImageLoader="clr-namespace:AsyncImageLoader;assembly=AsyncImageLoader.Avalonia"
    xmlns:components="clr-namespace:DiscordChatExporter.Gui.ViewModels.Components"
    xmlns:converters="clr-namespace:DiscordChatExporter.Gui.Converters"
    xmlns:materialIcons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
    xmlns:materialStyles="clr-namespace:Material.Styles.Controls;assembly=Material.Styles"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    <DockPanel>
        <!--  Header  -->
        <StackPanel
            Background="{DynamicResource MaterialDarkBackgroundBrush}"
            DockPanel.Dock="Top"
            Orientation="Vertical">
            <Grid ColumnDefinitions="*,Auto" Margin="12,12,8,12">
                <materialStyles:Card Grid.Column="0">
                    <!--  Token  -->
                    <TextBox
                        FontSize="16"
                        PasswordChar="*"
                        RevealPassword="{Binding $self.IsFocused}"
                        Text="{Binding Token}"
                        Theme="{DynamicResource SoloTextBox}"
                        Watermark="{Binding LocalizationManager.TokenWatermark}"
                        x:Name="TokenValueTextBox">
                        <TextBox.InnerLeftContent>
                            <materialIcons:MaterialIcon
                                Foreground="{DynamicResource PrimaryHueMidBrush}"
                                Grid.Column="0"
                                Height="24"
                                Kind="Key"
                                Margin="4,0,8,0"
                                Width="24" />
                        </TextBox.InnerLeftContent>
                        <TextBox.InnerRightContent>
                            <Button
                                Command="{Binding PullGuildsCommand}"
                                Grid.Column="2"
                                IsDefault="True"
                                Margin="8,0,0,0"
                                Padding="4"
                                Theme="{DynamicResource MaterialFlatButton}"
                                ToolTip.Tip="{Binding LocalizationManager.PullGuildsTooltip}">
                                <materialIcons:MaterialIcon
                                    Height="24"
                                    Kind="ArrowRight"
                                    Width="24" />
                            </Button>
                        </TextBox.InnerRightContent>
                    </TextBox>
                </materialStyles:Card>

                <!--  Settings button  -->
                <Button
                    Command="{Binding ShowSettingsCommand}"
                    Foreground="{DynamicResource MaterialDarkForegroundBrush}"
                    Grid.Column="1"
                    Margin="8,0,0,0"
                    Padding="8"
                    Theme="{DynamicResource MaterialFlatButton}"
                    ToolTip.Tip="{Binding LocalizationManager.SettingsTooltip}"
                    VerticalAlignment="Center">
                    <materialIcons:MaterialIcon
                        Height="24"
                        Kind="Settings"
                        Width="24" />
                </Button>
            </Grid>

            <!--  Progress  -->
            <ProgressBar
                Background="Transparent"
                Height="2"
                IsIndeterminate="{Binding IsProgressIndeterminate}"
                Value="{Binding Progress.Current.Fraction, Mode=OneWay}" />
        </StackPanel>

        <!--  Body  -->
        <Panel
            Background="{DynamicResource MaterialCardBackgroundBrush}"
            DockPanel.Dock="Bottom"
            IsEnabled="{Binding !IsBusy}">
            <Panel.Styles>
                <Style Selector="Panel">
                    <Style Selector="^:disabled">
                        <Setter Property="Opacity" Value="0.5" />
                    </Style>
                </Style>
            </Panel.Styles>
            <!--  Guilds and channels  -->
            <Grid ColumnDefinitions="Auto,*" IsVisible="{Binding !!AvailableGuilds.Count}">
                <!--  Guilds  -->
                <Border
                    BorderBrush="{DynamicResource MaterialDividerBrush}"
                    BorderThickness="0,0,1,0"
                    Grid.Column="0">
                    <ListBox
                        ItemsSource="{Binding AvailableGuilds}"
                        ScrollViewer.VerticalScrollBarVisibility="Hidden"
                        SelectedItem="{Binding SelectedGuild}"
                        SelectionChanged="AvailableGuildsListBox_OnSelectionChanged"
                        SelectionMode="Single"
                        x:Name="AvailableGuildsListBox">
                        <ListBox.Styles>
                            <Style Selector="ListBox">
                                <Style Selector="^ ListBoxItem">
                                    <Setter Property="Padding" Value="0" />
                                    <Setter Property="Cursor" Value="Hand" />
                                </Style>
                            </Style>
                        </ListBox.Styles>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Panel Background="Transparent" ToolTip.Tip="{Binding Name}">
                                    <!--  Guild icon placeholder  -->
                                    <Ellipse
                                        Fill="{DynamicResource MaterialDividerBrush}"
                                        Height="48"
                                        Margin="12"
                                        Width="48" />

                                    <!--  Guild icon  -->
                                    <Ellipse
                                        Height="48"
                                        Margin="12"
                                        Width="48">
                                        <Ellipse.Fill>
                                            <ImageBrush asyncImageLoader:ImageBrushLoader.Source="{Binding IconUrl}" />
                                        </Ellipse.Fill>
                                    </Ellipse>
                                </Panel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Border>

                <!--  Channels  -->
                <Border Grid.Column="1">
                    <TreeView
                        ItemsSource="{Binding AvailableChannels}"
                        SelectedItems="{Binding SelectedChannels}"
                        SelectionChanged="AvailableChannelsTreeView_OnSelectionChanged"
                        SelectionMode="Multiple"
                        TextSearch.Text="Name"
                        x:Name="AvailableChannelsTreeView">
                        <TreeView.Styles>
                            <Style Selector="TreeView">
                                <Style Selector="^ TreeViewItem">
                                    <Setter Property="Padding" Value="0" />
                                    <Setter Property="Cursor" Value="Hand" />
                                </Style>
                            </Style>
                        </TreeView.Styles>
                        <TreeView.ItemTemplate>
                            <TreeDataTemplate ItemsSource="{Binding Children}">
                                <Grid
                                    Background="Transparent"
                                    Classes.category="{Binding Channel.IsCategory}"
                                    ColumnDefinitions="Auto,*,Auto">
                                    <Grid.Styles>
                                        <Style Selector="Grid">
                                            <Style Selector="^:not(.category)">
                                                <Setter Property="ToolTip.Tip">
                                                    <Template>
                                                        <TextBlock>
                                                            <Run Text="{Binding #UserControl.DataContext.LocalizationManager.LastMessageSentTooltip}" />
                                                            <Run FontWeight="SemiBold" Text="{Binding Channel.LastMessageId, Converter={x:Static converters:SnowflakeToTimestampStringConverter.Instance}, TargetNullValue=never, Mode=OneWay}" />
                                                        </TextBlock>
                                                    </Template>
                                                </Setter>
                                            </Style>
                                        </Style>
                                    </Grid.Styles>

                                    <!--  Channel icon  -->
                                    <materialIcons:MaterialIcon
                                        Classes.voice="{Binding Channel.IsVoice}"
                                        Grid.Column="0"
                                        IsVisible="{Binding !Channel.IsCategory}"
                                        Margin="0,0,4,0">
                                        <materialIcons:MaterialIcon.Styles>
                                            <Style Selector="materialIcons|MaterialIcon">
                                                <Setter Property="Kind" Value="Pound" />

                                                <Style Selector="^.voice">
                                                    <Setter Property="Kind" Value="VolumeHigh" />
                                                </Style>
                                            </Style>
                                        </materialIcons:MaterialIcon.Styles>
                                    </materialIcons:MaterialIcon>

                                    <!--  Channel name  -->
                                    <TextBlock
                                        FontSize="14"
                                        Grid.Column="1"
                                        Margin="0,12"
                                        Text="{Binding Channel.Name, Mode=OneWay}" />

                                    <!--  Checkmark  -->
                                    <materialIcons:MaterialIcon
                                        Grid.Column="2"
                                        Height="24"
                                        IsVisible="{Binding $parent[TreeViewItem].IsSelected}"
                                        Kind="Check"
                                        Margin="16,0"
                                        Width="24" />
                                </Grid>
                            </TreeDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                </Border>
            </Grid>

            <!--  Placeholder / usage instructions  -->
            <Panel IsVisible="{Binding !AvailableGuilds.Count}">
                <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="32,16" Spacing="0">
                        <!--  User token  -->
                        <TextBlock>
                            <InlineUIContainer>
                                <materialIcons:MaterialIcon
                                    Foreground="{DynamicResource PrimaryHueMidBrush}"
                                    Height="18"
                                    Kind="Account"
                                    Width="18" />
                            </InlineUIContainer>
                            <Run BaselineAlignment="Center" Text="" />
                            <Run
                                BaselineAlignment="Center"
                                FontSize="16"
                                FontWeight="SemiBold"
                                Text="{Binding LocalizationManager.TokenPersonalHeader}" />
                        </TextBlock>

                        <TextBlock
                            FontSize="14"
                            FontWeight="Light"
                            Inlines="{Binding LocalizationManager.TokenPersonalTosWarning, Converter={x:Static converters:MarkdownToInlinesConverter.Instance}}"
                            LineHeight="23"
                            TextWrapping="Wrap" />

                        <TextBlock
                            FontSize="14"
                            FontWeight="Light"
                            Inlines="{Binding LocalizationManager.TokenPersonalInstructions, Converter={x:Static converters:MarkdownToInlinesConverter.Instance}}"
                            LineHeight="23"
                            TextWrapping="Wrap" />

                        <!--  Bot token  -->
                        <TextBlock Margin="0,12,0,0">
                            <InlineUIContainer>
                                <materialIcons:MaterialIcon
                                    Foreground="{DynamicResource PrimaryHueMidBrush}"
                                    Height="18"
                                    Kind="Robot"
                                    Width="18" />
                            </InlineUIContainer>
                            <Run BaselineAlignment="Center" Text="" />
                            <Run
                                BaselineAlignment="Center"
                                FontSize="16"
                                FontWeight="SemiBold"
                                Text="{Binding LocalizationManager.TokenBotHeader}" />
                        </TextBlock>

                        <TextBlock
                            FontSize="14"
                            FontWeight="Light"
                            Inlines="{Binding LocalizationManager.TokenBotInstructions, Converter={x:Static converters:MarkdownToInlinesConverter.Instance}}"
                            LineHeight="23"
                            TextWrapping="Wrap" />

                        <TextBlock
                            FontSize="14"
                            FontWeight="Light"
                            Inlines="{Binding LocalizationManager.TokenHelpText, Converter={x:Static converters:MarkdownToInlinesConverter.Instance}}"
                            LineHeight="23"
                            Margin="0,12,0,0"
                            TextWrapping="Wrap" />
                    </StackPanel>
                </ScrollViewer>
            </Panel>

            <!--  Export button  -->
            <Button
                Background="{DynamicResource MaterialSecondaryMidBrush}"
                Command="{Binding ExportCommand}"
                Foreground="{DynamicResource MaterialSecondaryMidForegroundBrush}"
                Height="56"
                HorizontalAlignment="Right"
                IsVisible="{Binding $self.IsEffectivelyEnabled}"
                Margin="32,24"
                Padding="0"
                Theme="{DynamicResource MaterialIconButton}"
                VerticalAlignment="Bottom"
                Width="56">
                <materialIcons:MaterialIcon
                    Height="32"
                    Kind="Download"
                    Width="32" />
            </Button>
        </Panel>
    </DockPanel>
</UserControl>